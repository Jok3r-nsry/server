var LatestActionID = 0;
var isAdd = true;

function IncrementCart(CartItemID) {
    LatestActionID++;
    var ThisActionID = LatestActionID;
    ToggleLoadingAnimation(true, CartItemID);
    document.getElementById(CartItemID + "amount").value++;
    isAdd = true;
    setTimeout(function () { CartDebounceHandler(ThisActionID, CartItemID); }, 750);
}

function DecrementCart(CartItemID) {
    LatestActionID++;
    var ThisActionID = LatestActionID;
    ToggleLoadingAnimation(true, CartItemID);
    document.getElementById(CartItemID + "amount").value--;
    isAdd = false;
    setTimeout(function () { CartDebounceHandler(ThisActionID, CartItemID); }, 750);
}

function DoPhoneCartInsert(caller) {
    var skuid = "";
    if (document.getElementById('price_2').checked) {
        skuid = document.getElementById('price_2').attributes["SKUID"].value;
        if (skuid != "" && skuid != null) DoCartInsert(skuid, 1, caller, "postMobileSwitch");
    }
    else if (document.getElementById('price_1').checked) {
        skuid = document.getElementById('price_1').attributes["SKUID"].value;
        if (skuid != "" && skuid != null) DoCartInsert(skuid, 1, caller, "postMobileNew");
    }

}

function DoCartInsert(SKUID, newAmount, caller, type) {
    caller.classList.add("bn--disabled");
    document.getElementById("cartPopupCheckoutButton").classList.add("bn--disabled");
    if (newAmount == null && document.getElementById("PDPamount") != null) newAmount = document.getElementById("PDPamount").value;
    if (newAmount === "" || newAmount == null || isNaN(newAmount)) newAmount = 1;


    var Token = document.getElementById("CartActionToken").value;

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/Anpost/ShopServices.asmx/AddProductToShoppingCart", true);
    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

    xhr.onload = function () {
        var results = xhr.responseXML.getElementsByTagName("string")
        var result = results[0].childNodes[0].nodeValue;
        cartResponse = JSON.parse(result);

        if (cartResponse.ActionResult == "inserted" || cartResponse.ActionResult == "updated") {
            RefreshCartPopup(cartResponse);
            RefreshCartHeaderIcon(cartResponse.CartItemCount);
            if (cartResponse.ActionItem != null && cartResponse.ActionResult == "inserted") GTAGAddToCartPush(cartResponse.ActionItem, newAmount, type);
        }
        if (cartResponse.ActionResult == "invalid") {
            RefreshCartPopup(cartResponse);
        }
        document.getElementById("m58Container").class = "m58--open";
        caller.classList.remove("bn--disabled");
        document.getElementById("cartPopupCheckoutButton").classList.remove("bn--disabled");

    }
    xhr.onerror = function () {
        alert("Encountered Error contacting Cart Service");
        caller.classList.remove("bn--disabled");
        document.getElementById("cartPopupCheckoutButton").classList.remove("bn--disabled");
    }
    xhr.send("SkuID=" + SKUID + "&quantity=" + newAmount + "&addType=" + type + "&CartActionToken=" + Token);
}

function DoCartUpdate(CartItemID, newAmount) {
    if (newAmount >= 0) ToggleLoadingAnimation(true, CartItemID);
    if (newAmount == null) newAmount = document.getElementById(CartItemID + "amount").value;
    if (newAmount === "") newAmount = 1;

    var Token = document.getElementById("CartActionToken").value;
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/Anpost/ShopServices.asmx/UpdateCart", true);
    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

    xhr.onload = function () {
        var results = xhr.responseXML.getElementsByTagName("string")
        var result = results[0].childNodes[0].nodeValue;
        cartResponse = JSON.parse(result);

        if (cartResponse.ActionResult == "updated") {
            RefreshCartTotals(cartResponse);
            RefreshCartHeaderIcon(cartResponse.CartItemCount);
            RefeshCartItemValues(cartResponse, CartItemID);
            if (cartResponse.ActionItem != null)
            {
                if(isAdd)
                    GTAGAddToCartPush(cartResponse.ActionItem, newAmount, '');
                else
                    GTAGARemoveFromCartPush(cartResponse.ActionItem, 1);
            }
        }
        if (cartResponse.ActionResult == "invalid") {
            RefreshCartTotals(cartResponse);
            RefeshCartItemValues(cartResponse, CartItemID);
            //alert("Error updating cart: " + cartResponse.ActionErrorMessage); // TO DO Error handling 500
        }
        if (cartResponse.ActionResult == "removed") {
            document.getElementById(CartItemID + "container").style.display = "none";
            RefreshCartTotals(cartResponse);
            RefreshCartHeaderIcon(cartResponse.CartItemCount);
            if (cartResponse.ActionItem != null) GTAGARemoveFromCartPush(cartResponse.ActionItem, newAmount);

        }
        ToggleLoadingAnimation(false, CartItemID);
    }
    xhr.onerror = function () {
        ToggleLoadingAnimation(false);
    }
    xhr.send("cartItemID=" + CartItemID + "&newAmount=" + newAmount + "&CartActionToken=" + Token);
}

//RESPONSE METHODS
function RefreshCartPopup(cartResponse) {
    var cartPopupItemContainer = document.getElementById("m58__products");
    cartPopupItemContainer.innerHTML = "";
    cartResponse.CartItems.map(createCartItemHtml);
    if (cartResponse.ActionErrorMessage != "") document.getElementById("cartPopupErrorMessage").innerText = cartResponse.ActionErrorMessage;
    document.getElementById("cartPopupTotal").innerText = "Total: " + cartResponse.CartTotalPriceFormatted;

    var checkoutlink = document.getElementById("cartPopupCheckoutButton"); //document.getElementById("p_lt_WebPartZone7_zoneContent_pageplaceholder_p_lt_ctl00_CartSummary_checkoutButtonContainer");

    if (cartResponse.CartSubTotalPrice < 2 || cartResponse.CartSubTotalPrice > 5000) {
        checkoutlink.className = "bn bn--primary gtm-cta bn--disabled";
    }
    else {
        checkoutlink.className = "bn bn--primary gtm-cta";
    }
}

function RefeshCartItemValues(cartResponse, CartItemID) {
    document.getElementById(CartItemID + "itemTotal").innerText = cartResponse.ActionItemPrice;
    if (cartResponse.ActionErrorMessage != "") {
        document.getElementById(CartItemID + "errorMessageInner").innerText = cartResponse.ActionErrorMessage;
        document.getElementById(CartItemID + "errorMessage").style.display = "block";
    }
    else {
        document.getElementById(CartItemID + "errorMessageInner").innerText = "";
        document.getElementById(CartItemID + "errorMessage").style.display = "none";
    }
}

function RefreshCartHeaderIcon(itemCount) {
    var circles = document.querySelectorAll(".header__basket__circle");
    var baskets = document.querySelectorAll(".header__basket__number");
    var shopBaskets = document.querySelectorAll(".js-shop-basket-number");
    var cnpBasket = document.querySelector(".js-clickpost-basket-number");

    for (var i = 0; i < circles.length; i++) {
        if (itemCount <= 0 && !cnpBasket) {
            circles[i].style.display = "none";
            baskets[i].style.display = "none";
        } else {
            // If there is a Click and Post item in the basket
            if (cnpBasket) {
                // Add the shop items and the C&P item count together
                baskets[i].innerHTML = parseInt(itemCount) + parseInt(cnpBasket.innerHTML);

                if (shopBaskets.length) {
                    // Hide the C&P icon if necessary 
                    if (itemCount <= 0) {
                        shopBaskets[i].style.display = "none";
                    } else {
                        shopBaskets[i].style.display = "inline-block";
                        shopBaskets[i].innerHTML = parseInt(itemCount);
                    }
                }
            } else {
                circles[i].style.display = "block";
                baskets[i].style.display = "block";
                baskets[i].innerHTML = itemCount;
            }

        }
    }
}

function RefreshCartTotals(cartResponse) {
    if (document.getElementById("grandTotal") != null) document.getElementById("grandTotal").innerText = cartResponse.CartTotalPriceFormatted;
    if (document.getElementById("shippingTotal") != null) document.getElementById("shippingTotal").innerText = cartResponse.CartShippingPrice;
    if (document.getElementById("subTotal") != null) document.getElementById("subTotal").innerText = cartResponse.CartSubTotalPriceFormatted;
    if (document.getElementById("discountTotal") != null) document.getElementById("discountTotal").innerText = cartResponse.CartDiscountPrice;

    var checkoutlink = document.getElementById("checkoutLink");
    var cartEmptyMessage = document.getElementById("cartEmptyMessage");
    if (cartEmptyMessage == null || checkoutlink == null) return;

    checkoutlink.className = "bn bn--primary gtm-cta";

    if (cartResponse.CartState == "empty") { //CART EMPTY
        cartEmptyMessage.style.display = "block";
        checkoutlink.classList.add("bn--disabled");
    }
    else cartEmptyMessage.style.display = "none";

    if (cartResponse.CartState == "NoCheckout") checkoutlink.classList.add("bn--disabled");
}

function createCartItemHtml(item) {
    document.getElementById("m58__products").innerHTML += "<div class='m58__product__item flex--space-between'><div class='m58__product__desc'><p class='m58__text'>" + item.name + "</p></div><div class='m58__product__price'><div class='m58__product__item__quant'><p class='m58__text'>" + item.quantity + " x</p></div><div class='m58__product__item__price'><p class='m58__text'>" + item.PriceFormatted + "</p></div></div></div>";
}

//Utility METHODS
function CartDebounceHandler(ActionID, CartItemID) {
    if (ActionID === LatestActionID) DoCartUpdate(CartItemID);
}

function ToggleLoadingAnimation(show, CartItemID) {
    var divs = document.getElementsByClassName("loader-wrapper");
    for (var i = 0; i < divs.length; i++) {
        if (show) divs[i].style.display = "initial";
        else divs[i].style.display = "none";
    }

    var itemTotalEl = document.getElementById(CartItemID + "itemTotal");

    if (show) {
        if (itemTotalEl !== null) itemTotalEl.className = "s05__aside__desc s05__aside__desc--loading";
        document.getElementById("grandTotal").className = "s05__aside__desc s05__aside__desc--loading";
        document.getElementById("shippingTotal").className = "s05__aside__desc s05__aside__desc--loading";
        document.getElementById("subTotal").className = "s05__aside__desc s05__aside__desc--loading";
        if (document.getElementById("discountTotal") != null) document.getElementById("discountTotal").className = "s05__aside__desc s05__aside__desc--loading";
        document.getElementById("checkoutLink").className = "bn bn--primary gtm-cta bn--disabled";
    }
    else {
        if (itemTotalEl !== null) itemTotalEl.className = "s05__aside__desc";
        document.getElementById("grandTotal").className = "s05__aside__desc";
        document.getElementById("shippingTotal").className = "s05__aside__desc";
        document.getElementById("subTotal").className = "s05__aside__desc";
        if (document.getElementById("discountTotal") != null) document.getElementById("discountTotal").className = "s05__aside__desc";
    }

    //if (cartResponse.CartState == "NoCheckout") checkoutlink.classList.add("bn--disabled");
}

var GAproductslist = [];
function GTAGAddToCartPush(productObj, Quantity, type) {
    var mobileNumber = "";
    if (type == "postMobileSwitch") mobileNumber = "Switch my number";
    else if (type == "postMobileNew") mobileNumber = "Get a new number";
    dataLayer.push({
        'event': 'addToCart',
        'ecommerce': {
            'currencyCode': 'EUR',
            'mobileNumber': mobileNumber,
            'add': {
                'products': [productObj]
            }
        }
    });
}

function GTAGARemoveFromCartPush(productObj, Quantity) {
    dataLayer.push({
        'event': 'removeFromCart',
        'ecommerce': {
            'currencyCode': 'EUR',
            'remove': {
                'products': [productObj]
            }
        }
    });
}

function productClick(productObj, type) {
    dataLayer.push({
        'event': 'productClick',
        'ecommerce': {
            'click': {
                'actionField': { 'list': type },
                'products': [productObj]
            }
        }
    });
}

function productView(product, type) {
    dataLayer.push({
        'event': 'productView',
        'ecommerce': {
            'detail': {
                'actionField': { 'list': type },
                'products': [product]
            }
        }
    });
}

function productImpressions() {
    dataLayer.push({
        'ecommerce': {
            'currencyCode': 'EUR',
            'impressions': GAproductslist
        }
    });
}

function GTAGACheckoutPush(step, products) {
    dataLayer.push({
        'event': 'checkout',
        'ecommerce': {
            'checkout': {
                'actionField': { 'step': step },
                'products': products
            }
        }
    });
}